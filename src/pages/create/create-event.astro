---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Create an Event">
    <h2 class="title">調整くん</h2>
    <form id="eventForm" class="form"> <!-- ここに id="eventForm" を追加 -->
        <div class="step1">
            <div class="step-title">
                <div>
                    <label for="eventName">Step1)イベント名</label>
                    <br>
                    <span>※忘年会、打ち合わせなど</span>
                </div>
                <input type="text" id="eventName" name="eventName" placeholder="ソフトウェア開発部お花見" required />
            </div> 
            <div>
                <label for="eventMemo">メモ（任意）</label>
                <br>
                <span>※飲み会の日程調整をしましょう！</span>
            </div>
            <textarea rows="10" cols="25" id="eventMemo" name="eventMemo" placeholder="ソフトウェア開発部でお花見をしましょう♩" required></textarea>
        </div>

        <div class="step2">
            <div class="step-title">
                <label for="eventName">Step2)日程候補</label>
                <br>
                <span>※候補日程/日時を入力してください</span>
                <br>
                <span>候補の区切りは改行で判断されます。</span>
                <br>
            </div>
            <div class="date-picker" >
                <div>
                    <span>例:</span>
                    <br>
                    <span>8/7(月)20:00〜</span>
                    <br>
                    <span>8/8(火)20:00〜</span>
                    <br>
                    <span>8/9(水)21:00〜</span>
                    <br>
                    <textarea
                        rows="10" cols="25"
                        id="eventDate"
                        name="eventDate"
                        placeholder="8/7(月)20:00〜\n8/8(火)20:00〜\n8/9(水)21:00〜"
                        required
                    />
                </div>
                <div>
                    <span>↓日付をクリックすると日程に日時が入ります。</span><br>
                    <input type="date" name="" id="">   
                </div>
            </div>
        </div>
        <!-- <label for="eventDates">Date Options:</label>
        <input type="text" id="eventDates" name="eventDates" required /> -->

        <button class="submit-button" type="submit">イベント作成</button>
    </form>
</Layout>

<script type="module">
    const getCurrentTimestamp = () => new Date().toISOString();

    const eventForm = document.getElementById('eventForm');

    eventForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(event.target);
        const eventName = formData.get('eventName');
        const eventMemo = formData.get('eventMemo');
        const eventDates = formData.get('eventDates');

        // Example data for missing variables
        const eventCreaterName = 'Anonymous User'; // Or pull from a cookie or user session
        const eventCreateTime = getCurrentTimestamp();
        const eventUpdateTime = eventCreateTime;

        const response = await fetch('/api/createevent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                event_name: eventName,
                event_memo: eventMemo,
                event_create_time: eventCreateTime
            })
        });

        const data = await response.json();
        console.log(data[0]);

        if (response.ok) {
            // Redirect to a confirmation or details page (replace with appropriate URL structure)
            window.location.href = `/create/show-event-url-${data[0].event_no}`;
        } else {
            console.error('Error inserting event:', data.error);
        }
    });
</script>